{{ $s := newScratch }}
{{ $s.Set "data" dict }}
{{ $s.Set "body" dict }}

{{ with $data := .data }}
  {{ with .id }}
    {{ $s.SetInMap "data" "id" (print . $.type $.iteration | md5)}}
  {{ end }}
  {{ $title := .title }}
  {{ if gt $.iteration 1 }}
    {{ $title = printf "%s %v" $title $.iteration }}
  {{ end }}
  {{ $s.SetInMap "data" "title" $title }}
  {{ with .price }}
    {{ $s.SetInMap "data" "price" . }}
  {{ end }}
  {{ with .date }}
    {{ $s.SetInMap "data" "date" . }}
  {{ end }}

  {{ $content_blocks := slice }}

  {{ with .content_1 }}
    {{ $content_blocks = $content_blocks | append . }}
  {{ end }}

  {{ with partial "random/content/blocks" $.content }}
    {{ $content_blocks = $content_blocks | append . }}
  {{ end }}

  {{ with $content_blocks }}
    {{ $s.Set "content" (delimit $content_blocks "\n\n") }}
  {{ end }}

  {{ with .tags }}
    {{ $s.SetInMap "data" "tags" . }}
  {{ end }}
  {{ with .categories }}
    {{ $s.SetInMap "data" "categories" . }}
  {{ end }}
  {{ with .description }}
    {{ $s.SetInMap "data" "description" . }}
  {{ end }}
  {{ if eq $.type "post" }}
    {{ $profiles := site.Data.profiles }}
    {{ with where site.Params.collections "mame" "profiles" }}
      {{ with (index . 0).limit }}
        {{ $profiles = first . $profiles }}
      {{ end }}
    {{ end }}
    {{ with index ($profiles | shuffle) 0 }}
      {{ with urlize .title }}
        {{ $s.SetInMap "data" "authors" (slice (printf "/profile/%s.md" .)) }}
      {{ end }}
    {{ end }}
  {{ end }}


  {{ with .twitter }}
    {{ $s.SetInMap "data" "twitter_handle" . }}
  {{ end }}

  {{ $download := false }}

  {{ with $url := .image }}
    {{ if and $download (eq $data.type "profile") }}
      {{ with resources.GetRemote . }}
        {{ .Publish }}
        {{ $s.SetInMap "data" "image" $url }}
      {{ end }}
    {{ else }}
      {{ with split . "?" }}
        {{ with index . 0 }}
          {{ $s.SetInMap "data" "image" . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with .image_data }}
    {{ $s.SetInMap "data" "image" (printf "https://placeimg.com/%v/%v/any" .width .height) }}
  {{ end }}

  {{ with .location }}
    {{ $s.SetInMap "data" "location" . }}
  {{ end }}

  {{ with .sizes }}
    {{ $s.SetInMap "data" "sizes" . }}
  {{ end }}

  {{/* This is for current work on https://github.com/theNewDynamic/retroreport.org/pull/703 */}}
  {{ if false }}
  {{ if eq .type "profile" }}
    {{ $s.SetInMap "data" "description" (partial "random/paragraph") }}
    {{ $profile_types := slice
      "educators"
      "ambassadors"
    }}
    {{ $s.SetInMap "data" "profile_type" (partial "random/indexof" $profile_types) }}
    {{ with last 1 (split .title " ") }}
      {{ with index . 0 }}
        {{ $s.SetInMap "data" "last_name" . }}
      {{ end }}
    {{ end }}
    {{ $cities := slice
      "New York, NY"
      "Los Angelees, CA"
      "San Francisco, CA"
      "Boston, MA"
      "Philadelphia, PA"

    }}
    {{ $s.SetInMap "data" "location" (partial "random/indexof" $cities) }}
    {{ $schools := slice
    "Manhattan School of Children"
    "P.S. 191"
    "East Side Community High School"
    "Grammar School No. 35"
    }}
    {{ $s.SetInMap "data" "school" (partial "random/indexof" $schools) }}
    {{ $images := slice 
      "cd76ed43-a8ed-4d40-8511-49fe23ed4e6e-6.JPG"
      "nyweide-cropped.png"
      "alexandra_wallace_headshot_cropped.jpg"
      "1439920080119_board-nick-ascheim-300.jpg"
    }}

    {{ with partial "random/indexof" $images }}
      {{ with printf "/uploads/%s" . }}
        {{ $s.SetInMap "data" "image" . }}
      {{ end }}
    {{ end }}

  {{ end }}
  {{/* End of RetroReport only work */}}
  {{ end }}

  {{/* This if for current work on front matter blocks */}}
  {{ if false }}
    {{ $s.SetInMap "data" "blocks" (partial "random/front-matter/blocks") }}
  {{ end }}

{{ end }}



{{ return (dict
  "front_matter" ($s.Get "data")
  "content" ($s.Get "content")
  )
}}